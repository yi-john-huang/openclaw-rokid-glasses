# Project Structure

## Directory Organization
```
openclaw-rokid-glasses/
├── src/
│   └── rokid_bridge/           # Main package (src layout)
│       ├── __init__.py         # Package init + __version__
│       ├── app.py              # FastAPI app factory + routes + rate limiter
│       ├── config.py           # Settings via pydantic-settings (env vars)
│       ├── models.py           # Pydantic request/response models
│       ├── rokid_auth.py       # HMAC-SHA256 auth + replay protection
│       ├── image_handler.py    # Camera image → OpenAI vision format
│       ├── history.py          # Per-device in-memory conversation history
│       └── relay.py            # SSE streaming relay to Secure Stack
├── tests/
│   ├── __init__.py
│   ├── unit/
│   │   ├── __init__.py
│   │   ├── test_rokid_auth.py    # HMAC verify/reject, replay, timing
│   │   ├── test_image_handler.py # Image conversion, MIME, size limits
│   │   ├── test_relay.py         # AR prompt, history merge, streaming
│   │   └── test_history.py       # Append/get/clear, TTL eviction, truncation
│   └── integration/
│       ├── __init__.py
│       └── test_endpoints.py     # Full /chat flow, auth failures, rate limiting
├── .spec/
│   ├── steering/               # Project-wide steering documents (this dir)
│   │   ├── product.md
│   │   ├── tech.md
│   │   └── structure.md
│   └── specs/                  # Feature specifications (sdd-init creates these)
│       └── rokid-glasses-bridge/
│           ├── spec.json
│           ├── requirements.md
│           ├── design.md
│           └── tasks.md
├── .claude/
│   ├── agents/                 # Specialized agent definitions
│   ├── rules/                  # Always-active coding standards
│   └── hooks/                  # Lifecycle hooks
├── pyproject.toml              # Project config + dependencies (hatchling)
├── Dockerfile                  # Multi-stage, python:3.12-slim, non-root
├── docker-compose.yml          # Standalone deployment
├── docker-compose.override.yml # Co-deploy with openclaw-secure-stack
├── .env.example                # Environment variable template
└── CLAUDE.md                   # SDD workflow instructions
```

## Key Directories
- **src/rokid_bridge/**: Single Python package; all business logic lives here
- **tests/unit/**: Isolated tests with mocks; fast, no I/O
- **tests/integration/**: Full endpoint tests using FastAPI TestClient + mock httpx
- **.spec/specs/**: SDD spec files generated by the workflow

## Module Responsibilities (SRP)

| Module | Single Responsibility |
|--------|----------------------|
| `app.py` | HTTP routing, dependency wiring, rate limiting |
| `config.py` | Read and validate environment configuration |
| `models.py` | Define request/response shapes (Pydantic) |
| `rokid_auth.py` | HMAC verification and replay attack prevention |
| `image_handler.py` | Convert Rokid camera payload to OpenAI vision format |
| `history.py` | Store and retrieve per-device conversation turns |
| `relay.py` | Forward requests upstream and stream SSE responses back |

## File Naming Conventions
- **Source files**: `snake_case.py`
- **Test files**: `test_{module_name}.py`
- **Config files**: `pyproject.toml`, `.env.example`, `Dockerfile`
- **Constants**: `UPPER_SNAKE_CASE` within modules
- **Classes**: `PascalCase`
- **Functions/Variables**: `snake_case`

## Architectural Principles
- **Hexagonal Architecture**: app.py is the inbound adapter; relay.py is the outbound adapter
- **Dependency Injection**: relay.py, history.py injected into app factory (not instantiated inside routes)
- **No global state**: All stateful objects created in `create_app()` and closed over by routes
- **Separation of Concerns**: Auth, image, history, relay are independent — no cross-imports
- **Security by default**: Constant-time comparisons, replay window, rate limiting, non-root Docker

## Testing Structure
- **Unit tests**: Each module tested in isolation; mock all external I/O
- **Integration tests**: Use `fastapi.testclient.TestClient` + `unittest.mock.patch` on httpx
- **Coverage target**: 80% overall; 100% on `rokid_auth.py` and auth paths in `app.py`
- **TDD**: Red → Green → Refactor cycle per task

## Build Output
- **Command**: `docker build -t rokid-bridge .`
- **Output**: Docker image `rokid-bridge:latest`
- **Artifacts**: ASGI app served by uvicorn on port 8090
